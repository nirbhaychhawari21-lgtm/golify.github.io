<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOLIFY - Your Music</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        html {
            font-family: 'Inter', 'sans-serif';
        }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* Added height for horizontal scrollbars */
        }
        ::-webkit-scrollbar-track {
            background: #191414;
        }
        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Style the file input button */
        input[type="file"]::file-selector-button {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 9999px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #1ED760;
        }
    </style>

    <!-- === ADDED FIREBASE SCRIPT === -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      // import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js"; // <-- DISABLED TO FIX APP-OFFLINE ERROR
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries
    
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyABh26_26dUlGNfCcrx7U2f4HvJZkNbsHE",
        authDomain: "golifyweb.firebaseapp.com",
        projectId: "golifyweb",
        storageBucket: "golifyweb.firebasestorage.app",
        messagingSenderId: "1024410703184",
        appId: "1:1024410703184:web:964847399fb05779370855",
        measurementId: "G-4NHT1MEV56"
      };
    
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      // const analytics = getAnalytics(app); // <-- DISABLED TO FIX APP-OFFLINE ERROR
    </script>
    <!-- === END OF ADDED SCRIPT === -->

</head>
<body class="bg-[#121212] text-white overflow-hidden">

    <!-- Main App Container -->
    <div class="h-screen w-screen flex flex-col">

        <!-- App Body (Sidebar + Main Content) -->
        <div class="flex-1 flex overflow-hidden">

            <!-- Sidebar -->
            <aside class="w-64 bg-black p-6 flex-shrink-0 flex flex-col">
                <h1 class="text-3xl font-bold text-white mb-6">GOLIFY</h1>
                <nav class="flex-1">
                    <ul class="space-y-4">
                        <li><a href="#" class="flex items-center space-x-3 text-lg font-semibold text-gray-400 hover:text-white transition-colors" onclick="showView('home')">
                            <!-- Home Icon -->
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2.5a.5.5 0 01.5-.5h3a.5.5 0 01.5.5V17a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                            <span>Home</span>
                        </a></li>
                        <li><a href="#" class="flex items-center space-x-3 text-lg font-semibold text-gray-400 hover:text-white transition-colors" onclick="showView('search')">
                            <!-- Search Icon -->
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
                            <span>Search</span>
                        </a></li>
                        <li><a href="#" class="flex items-center space-x-3 text-lg font-semibold text-gray-400 hover:text-white transition-colors" onclick="showView('artists')">
                            <!-- Artist Icon -->
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                            <span>Artists</span>
                        </a></li>
                        <li><a href="#" class="flex items-center space-x-3 text-lg font-semibold text-gray-400 hover:text-white transition-colors" onclick="showView('library')">
                            <!-- Library Icon -->
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1zM1 15a1 1 0 100 2h18a1 1 0 100-2H1z"></path></svg>
                            <span>Your Library</span>
                        </a></li>
                    </ul>
                </nav>

                <!-- Add Song Button -->
                <button class="w-full bg-white text-black font-semibold py-3 rounded-full hover:bg-gray-200 transition-colors" onclick="openAddSongModal()">
                    Add New Song
                </button>

                <!-- Divider -->
                <hr class="border-gray-800 my-4">

                <!-- Playlists -->
                <div class="flex-1 overflow-y-auto">
                    <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Playlists</h2>
                    <ul id="playlist-list" class="space-y-2">
                        <!-- Playlists will be dynamically inserted here -->
                    </ul>
                    <button class="mt-4 text-gray-400 hover:text-white font-semibold text-sm flex items-center space-x-2" onclick="createPlaylist()">
                        <!-- Plus Icon -->
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                        <span>Create Playlist</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main id="main-content" class="flex-1 bg-gradient-to-b from-[#222] to-[#121212] overflow-y-auto p-8">
                
                <!-- Home View -->
                <div id="home-view">
                    <h2 class="text-3xl font-bold mb-6">Welcome to GOLIFY</h2>
                    
                    <!-- Recently Added -->
                    <h3 class="text-2xl font-semibold mb-4">Recently Added</h3>
                    <div id="home-recent-container" class="flex space-x-6 overflow-x-auto pb-4">
                        <!-- Recently added songs will appear here -->
                        <p class="text-gray-400">No songs added yet.</p>
                    </div>

                    <!-- NEW: Your Playlists -->
                    <h3 class="text-2xl font-semibold mt-8 mb-4">Your Playlists</h3>
                    <div id="home-playlists-container" class="flex space-x-6 overflow-x-auto pb-4">
                        <!-- Playlist cards will appear here -->
                        <p class="text-gray-400">No playlists created yet.</p>
                    </div>

                    <!-- NEW: Featured Artists -->
                    <h3 class="text-2xl font-semibold mt-8 mb-4">Your Artists</h3>
                    <div id="home-artists-container" class="flex space-x-6 overflow-x-auto pb-4">
                        <!-- Artist cards will appear here -->
                        <p class="text-gray-400">No artists found in your library.</p>
                    </div>
                </div>

                <!-- Search View -->
                <div id="search-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">Search</h2>
                    <input type="text" id="search-bar" class="w-full p-3 rounded-full bg-[#333] text-white placeholder-gray-400 border-none focus:outline-none focus:ring-2 focus:ring-[#1DB954]" placeholder="What do you want to listen to?">
                    <div id="search-results" class="mt-6">
                        <!-- Search results will appear here -->
                    </div>
                </div>

                <!-- Library View -->
                <div id="library-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">Your Library</h2>
                    <div class="flex flex-col">
                        <div class="grid grid-cols-12 gap-4 px-4 pb-2 border-b border-gray-700 text-gray-400 text-sm font-semibold">
                            <div class="col-span-1">#</div>
                            <div class="col-span-5">TITLE</div>
                            <div class="col-span-4">ARTIST</div>
                            <div class="col-span-2">ACTIONS</div>
                        </div>
                        <div id="library-song-list" class="mt-4 space-y-2">
                            <!-- Song list will be dynamically inserted here -->
                            <p class="text-gray-400 p-4">Your library is empty. Click "Add New Song" to begin.</p>
                        </div>
                    </div>
                </div>

                <!-- Playlist View -->
                <div id="playlist-view" class="hidden">
                    <!-- Playlist header -->
                    <div class="flex items-end space-x-6 mb-8">
                        <img id="playlist-view-img" src="https://placehold.co/160x160/191414/1DB954?text=GOLIFY" class="w-40 h-40 rounded-lg shadow-lg" alt="Playlist Art" onerror="this.src='https://placehold.co/160x160/191414/1DB954?text=GOLIFY'">
                        <div>
                            <span class="text-sm font-semibold">Playlist</span>
                            <h1 id="playlist-view-name" class="text-5xl font-extrabold">My Playlist</h1>
                            <p id="playlist-view-desc" class="text-gray-300 mt-2">Songs will appear here.</p>
                        </div>
                    </div>
                    <!-- NEW: Playlist controls -->
                    <div class="flex items-center space-x-4 mb-8">
                        <button id="playlist-play-btn" class="w-14 h-14 bg-[#1DB954] rounded-full flex items-center justify-center text-black hover:scale-105 transition-transform" title="Play Playlist">
                            <svg class="w-6 h-6 ml-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11v11.78a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                        </button>
                        <button id="playlist-edit-btn" class="text-gray-400 hover:text-white" title="Edit Playlist">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 13H3V6a1 1 0 011-1h9l-2 2H5v7z"></path></svg>
                        </button>
                    </div>
                    <!-- Playlist song list -->
                    <div class="flex flex-col">
                        <div class="grid grid-cols-12 gap-4 px-4 pb-2 border-b border-gray-700 text-gray-400 text-sm font-semibold">
                            <div class="col-span-1">#</div>
                            <div class="col-span-5">TITLE</div>
                            <div class="col-span-4">ARTIST</div>
                            <div class="col-span-2">ACTIONS</div>
                        </div>
                        <div id="playlist-song-list" class="mt-4 space-y-2">
                            <!-- Songs in the playlist will be listed here -->
                        </div>
                    </div>
                </div>

                <!-- Artists View (List of all artists) -->
                <div id="artists-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">Artists</h2>
                    <div id="artist-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6">
                        <!-- Artist cards will be dynamically inserted here -->
                        <p class="text-gray-400 col-span-full">No artists found. Add songs to your library.</p>
                    </div>
                </div>

                <!-- Artist Detail View (Songs by one artist) -->
                <div id="artist-detail-view" class="hidden">
                    <!-- Header -->
                    <div class="flex items-end space-x-6 mb-8">
                        <!-- NEW: Added relative group for hover effect -->
                        <div class="relative group flex-shrink-0">
                            <img id="artist-detail-img" src="https://placehold.co/160x160/191414/1DB954?text=ARTIST" class="w-40 h-40 rounded-full shadow-lg object-cover" alt="Artist Art" onerror="this.src='https://placehold.co/160x160/191414/1DB954?text=ARTIST'">
                            <!-- NEW: Button to change image -->
                            <button id="change-artist-img-btn" class="absolute inset-0 w-full h-full bg-black/50 rounded-full flex items-center justify-center text-white text-sm font-semibold opacity-0 group-hover:opacity-100 transition-opacity">
                                Change Picture
                            </button>
                        </div>
                        <div>
                            <span class="text-sm font-semibold">Artist</span>
                            <h1 id="artist-detail-name" class="text-5xl font-extrabold">Artist Name</h1>
                            <p id="artist-detail-desc" class="text-gray-300 mt-2">Songs will appear here.</p>
                        </div>
                    </div>
                    <!-- Song list -->
                    <div class="flex flex-col">
                        <div class="grid grid-cols-12 gap-4 px-4 pb-2 border-b border-gray-700 text-gray-400 text-sm font-semibold">
                            <div class="col-span-1">#</div>
                            <div class="col-span-5">TITLE</div>
                            <div class="col-span-4">ARTIST</div>
                            <div class="col-span-2">ACTIONS</div>
                        </div>
                        <div id="artist-song-list" class="mt-4 space-y-2">
                            <!-- Songs by this artist will be listed here -->
                        </div>
                    </div>
                </div>

            </main>
        </div>

        <!-- Player Bar -->
        <footer class="h-24 bg-[#181818] border-t border-gray-800 p-4 flex items-center justify-between">
            <!-- Current Song Info -->
            <div class="w-1/4 flex items-center space-x-4">
                <img id="player-thumbnail" src="https://placehold.co/64x64/191414/1DB954?text=GOLIFY" alt="Album Art" class="w-16 h-16 rounded" onerror="this.src='https://placehold.co/64x64/191414/1DB954?text=GOLIFY'">
                <div>
                    <h3 id="player-title" class="font-semibold">No Song Playing</h3>
                    <p id="player-artist" class="text-sm text-gray-400">---</p>
                </div>
            </div>
            
            <!-- Player Controls -->
            <div class="w-1/2 flex flex-col items-center">
                <div class="flex items-center space-x-6">
                    <!-- Shuffle Button -->
                    <button class="text-gray-400 hover:text-white transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 111.414-1.414L9 9.586V4a1 1 0 011-1zM3 14a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                    </button>
                    <!-- Previous Button -->
                    <button class="text-gray-400 hover:text-white transition-colors" onclick="playPreviousSong()">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M8.447 13.908l-5.405-4.006a.75.75 0 010-1.114l5.405-4.006A.75.75 0 019 5.25v8.5a.75.75 0 01-.553.708zM9 5.25v8.5l5.405-4.006a.75.75 0 000-1.114L9 5.25z"></path></svg>
                    </button>
                    <!-- Play/Pause Button -->
                    <button id="play-pause-btn" class="w-10 h-10 rounded-full bg-white text-black flex items-center justify-center hover:scale-105 transition-transform">
                        <!-- Play Icon -->
                        <svg id="play-icon" class="w-6 h-6 ml-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11v11.78a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                        <!-- Pause Icon -->
                        <svg id="pause-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M5.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75A.75.75 0 007.25 3h-1.5zM12.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75A.75.75 0 0014.25 3h-1.5z"></path></svg>
                    </button>
                    <!-- Next Button -->
                    <button class="text-gray-400 hover:text-white transition-colors" onclick="playNextSong()">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M11.553 13.908l5.405-4.006a.75.75 0 000-1.114l-5.405-4.006A.75.75 0 0011 5.25v8.5a.75.75 0 00.553.708zM11 5.25v8.5L5.595 9.744a.75.75 0 010-1.114L11 5.25z"></path></svg>
                    </button>
                    <!-- Loop Button -->
                    <button class="text-gray-400 hover:text-white transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v1.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 5.586V4a1 1 0 011-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM10 17a1 1 0 01-1-1v-1.586l-3.293 3.293a1 1 0 11-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 11-1.414 1.414L11 14.414V16a1 1 0 01-1 1z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
                <!-- Seek Bar -->
                <div class="w-full flex items-center space-x-2 mt-2">
                    <span id="current-time" class="text-xs text-gray-400">0:00</span>
                    <input type="range" id="seek-bar" value="0" class="w-full h-1 bg-gray-700 rounded-full appearance-none cursor-pointer" style="--thumb-bg: #1DB954;">
                    <span id="duration" class="text-xs text-gray-400">0:00</span>
                </div>
            </div>

            <!-- Volume/Extras -->
            <div class="w-1/4 flex items-center justify-end space-x-4">
                <button class="text-gray-400 hover:text-white transition-colors" onclick="showShareModal('app')">
                    <!-- Share App Icon -->
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M13 4.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM8.5 6a4 4 0 100 8 4 4 0 000-8zM15 8.5a.5.5 0 01.5.5v1.455A3.988 3.988 0 008.5 14a3.988 3.988 0 00-7 2.045V17a.5.5 0 01-1 0v-.505A4.988 4.988 0 018.5 12a4.988 4.988 0 017-2.955V8a.5.5 0 01-.5-.5z"></path></svg>
                </button>
                <!-- Volume Control -->
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7.4 3.067a.75.75 0 00-1.12-.664L1.97 6.09a.75.75 0 000 1.328l4.31 3.69a.75.75 0 10.9-1.2L3.899 7.404l3.501-2.997a.75.75 0 00-.001-1.34zM9.5 5.25a.75.75 0 00-1.5 0v9.5a.75.75 0 001.5 0v-9.5zM12.6 3.067a.75.75 0 011.12-.664l4.31 3.69a.75.75 0 010 1.328l-4.31 3.69a.75.75 0 11-.9-1.2l3.28-2.81-3.5-2.997a.75.75 0 01-.001-1.34z"></path></svg>
                    <input type="range" id="volume-bar" min="0" max="1" step="0.01" value="1" class="w-24 h-1 bg-gray-700 rounded-full appearance-none cursor-pointer">
                </div>
            </div>
        </footer>
    </div>
    
    <!-- Audio Element (Hidden) -->
    <audio id="audio-player"></audio>

    <!-- Add Song Modal -->
    <div id="add-song-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-[#282828] p-8 rounded-lg shadow-lg w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Add New Song</h2>
            <form id="add-song-form" class="space-y-4">
                <div>
                    <label for="song-title" class="block text-sm font-semibold mb-1">Song Title</label>
                    <input type="text" id="song-title" class="w-full p-2 rounded bg-[#333] border border-gray-700 focus:outline-none focus:ring-2 focus:ring-[#1DB954]" required>
                </div>
                <div>
                    <label for="song-artist" class="block text-sm font-semibold mb-1">Artist</label>
                    <input type="text" id="song-artist" class="w-full p-2 rounded bg-[#333] border border-gray-700 focus:outline-none focus:ring-2 focus:ring-[#1DB954]" required>
                </div>
                <div>
                    <label for="song-file" class="block text-sm font-semibold mb-1">Audio File (MP3, WAV, etc.)</label>
                    <input type="file" id="song-file" accept="audio/*" class="w-full text-sm" required>
                </div>
                <div>
                    <label for="thumbnail-file" class="block text-sm font-semibold mb-1">Thumbnail Image (JPG, PNG)</label>
                    <input type="file" id="thumbnail-file" accept="image/*" class="w-full text-sm" required>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" class="px-6 py-2 rounded-full font-semibold bg-gray-500 hover:bg-gray-600 transition-colors" onclick="closeAddSongModal()">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-full font-semibold bg-[#1DB954] hover:bg-[#1ED760] transition-colors">Add Song</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add to Playlist Modal -->
    <div id="add-to-playlist-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-[#282828] p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">Add to Playlist</h2>
            <div id="modal-playlist-list" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- List of playlists to add to -->
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" class="px-6 py-2 rounded-full font-semibold bg-gray-500 hover:bg-gray-600 transition-colors" onclick="closeAddToPlaylistModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Song Modal -->
    <div id="edit-song-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-[#282828] p-8 rounded-lg shadow-lg w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Edit Song</h2>
            <form id="edit-song-form" class="space-y-4">
                <input type="hidden" id="edit-song-id">
                <div>
                    <label for="edit-song-title" class="block text-sm font-semibold mb-1">Song Title</label>
                    <input type="text" id="edit-song-title" class="w-full p-2 rounded bg-[#333] border border-gray-700 focus:outline-none focus:ring-2 focus:ring-[#1DB954]" required>
                </div>
                <div>
                    <label for="edit-song-artist" class="block text-sm font-semibold mb-1">Artist</label>
                    <input type="text" id="edit-song-artist" class="w-full p-2 rounded bg-[#333] border border-gray-700 focus:outline-none focus:ring-2 focus:ring-[#1DB954]" required>
                </div>
                <div>
                    <label for="edit-song-file" class="block text-sm font-semibold mb-1">Audio File (Optional: to replace)</label>
                    <input type="file" id="edit-song-file" accept="audio/*" class="w-full text-sm">
                </div>
                <div>
                    <label for="edit-thumbnail-file" class="block text-sm font-semibold mb-1">Thumbnail Image (Optional: to replace)</label>
                    <input type="file" id="edit-thumbnail-file" accept="image/*" class="w-full text-sm">
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" class="px-6 py-2 rounded-full font-semibold bg-gray-500 hover:bg-gray-600 transition-colors" onclick="closeEditSongModal()">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-full font-semibold bg-[#1DB954] hover:bg-[#1ED760] transition-colors">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW: Edit Playlist Modal -->
    <div id="edit-playlist-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-[#282828] p-8 rounded-lg shadow-lg w-full max-w-lg">
            
            <!-- Form View -->
            <div id="edit-playlist-form-view">
                <h2 class="text-2xl font-bold mb-6">Edit Playlist</h2>
                <form id="edit-playlist-form" class="space-y-4">
                    <input type="hidden" id="edit-playlist-id">
                    <div>
                        <label for="edit-playlist-name" class="block text-sm font-semibold mb-1">Playlist Name</label>
                        <input type="text" id="edit-playlist-name" class="w-full p-2 rounded bg-[#333] border border-gray-700 focus:outline-none focus:ring-2 focus:ring-[#1DB954]" required>
                    </div>
                    <div>
                        <label for="edit-playlist-image" class="block text-sm font-semibold mb-1">Playlist Image (Optional: to replace)</label>
                        <input type="file" id="edit-playlist-image" accept="image/*" class="w-full text-sm">
                    </div>
                    <div class="flex justify-between items-center pt-4">
                        <button type="button" class="px-6 py-2 rounded-full font-semibold bg-red-600 hover:bg-red-700 transition-colors" onclick="showDeleteConfirmation()">Delete Playlist</button>
                        <div>
                            <button type="button" class="px-6 py-2 rounded-full font-semibold bg-gray-500 hover:bg-gray-600 transition-colors" onclick="closeEditPlaylistModal()">Cancel</button>
                            <button type="submit" class="px-6 py-2 rounded-full font-semibold bg-[#1DB954] hover:bg-[#1ED760] transition-colors ml-4">Save Changes</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Confirmation View -->
            <div id="delete-playlist-confirm-view" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Are you sure?</h2>
                <p class="text-gray-300 mb-6">Are you sure you want to delete this playlist? This action cannot be undone.</p>
                <div class="flex justify-end space-x-4">
                    <button type="button" class="px-6 py-2 rounded-full font-semibold bg-gray-500 hover:bg-gray-600 transition-colors" onclick="cancelDeleteConfirmation()">Cancel</button>
                    <button type="button" id="confirm-delete-playlist-btn" class="px-6 py-2 rounded-full font-semibold bg-red-600 hover:bg-red-700 transition-colors">Yes, Delete</button>
                </div>
            </div>

        </div>
    </div>

    <!-- Custom Alert/Modal -->
    <div id="custom-alert" class="hidden fixed top-0 left-0 right-0 p-4 bg-[#1DB954] text-white text-center font-semibold z-50 shadow-lg" onclick="this.classList.add('hidden')">
        <p id="custom-alert-message">Message goes here!</p>
    </div>

    <!-- NEW: Hidden File Input for Artist Image -->
    <input type="file" id="artist-image-upload" class="hidden" accept="image/*">


    <script>
        // --- Database Setup ---
        let db;
        const DB_NAME = 'golifyDB';
        const DB_VERSION = 2; // No version bump needed just for adding optional property
        const SONG_STORE = 'songs';
        const PLAYLIST_STORE = 'playlists';
        const ARTIST_STORE = 'artists'; 

        const openDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                    reject('Database error');
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    // Check old version to apply upgrades incrementally
                    if (event.oldVersion < 1) {
                        // Songs store: { id, title, artist, audioBlob, imageBlob }
                        const songStore = db.createObjectStore(SONG_STORE, { keyPath: 'id', autoIncrement: true });
                        songStore.createIndex('title', 'title', { unique: false });
                        songStore.createIndex('artist', 'artist', { unique: false });
                        
                        // Playlists store: { id, name, songIds: [1, 2, 5], imageBlob? }
                        const playlistStore = db.createObjectStore(PLAYLIST_STORE, { keyPath: 'id', autoIncrement: true });
                        playlistStore.createIndex('name', 'name', { unique: false });
                    }
                    if (event.oldVersion < 2) {
                        // NEW: Create artist store for v2
                        // Store: { artistName (key), imageBlob }
                        const artistStore = db.createObjectStore(ARTIST_STORE, { keyPath: 'artistName' });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
            });
        };

        // --- Global State ---
        let currentSongs = []; // To hold all song metadata for search, etc.
        let currentPlaylists = [];
        let currentArtistImages = new Map(); 
        let currentlyPlaying = null; // The full song object from IDB
        let songToAddToPlaylist = null; // Temp holder for song ID
        let currentViewedPlaylistId = null; 

        // --- Audio Player Elements ---
        const audioPlayer = document.getElementById('audio-player');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const seekBar = document.getElementById('seek-bar');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const volumeBar = document.getElementById('volume-bar');

        // --- Player UI Elements ---
        const playerThumbnail = document.getElementById('player-thumbnail');
        const playerTitle = document.getElementById('player-title');
        const playerArtist = document.getElementById('player-artist');

        // --- Modals & Views ---
        const addSongModal = document.getElementById('add-song-modal');
        const editSongModal = document.getElementById('edit-song-modal');
        const addToPlaylistModal = document.getElementById('add-to-playlist-modal');
        const editPlaylistModal = document.getElementById('edit-playlist-modal'); // NEW
        const editPlaylistFormView = document.getElementById('edit-playlist-form-view'); // NEW
        const deletePlaylistConfirmView = document.getElementById('delete-playlist-confirm-view'); // NEW

        const views = {
            home: document.getElementById('home-view'),
            search: document.getElementById('search-view'),
            library: document.getElementById('library-view'),
            playlist: document.getElementById('playlist-view'),
            artists: document.getElementById('artists-view'),
            artistDetail: document.getElementById('artist-detail-view')
        };
 
        // --- Utility Functions ---
        const showAlert = (message) => {
            const alertBox = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('custom-alert-message');
            alertMessage.textContent = message;
            alertBox.classList.remove('hidden');
            setTimeout(() => {
                alertBox.classList.add('hidden');
            }, 3000);
        };

        const formatTime = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        };

        // --- View Navigation ---
        const showView = (viewName) => {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
            }
            if (viewName !== 'playlist') {
                currentViewedPlaylistId = null;
            }
        };

        // --- Song Functions ---
        const addSong = (songData) => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([SONG_STORE], 'readwrite');
                const store = transaction.objectStore(SONG_STORE);
                const request = store.add(songData);

                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error('Error adding song:', event.target.error);
                    reject(event.target.error);
                };
            });
        };

        const getAllSongs = () => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([SONG_STORE], 'readonly');
                const store = transaction.objectStore(SONG_STORE);
                const request = store.getAll();

                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => {
                    console.error('Error getting songs:', event.target.error);
                    reject(event.target.error);
                };
            });
        };

        const getSongById = (id) => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([SONG_STORE], 'readonly');
                const store = transaction.objectStore(SONG_STORE);
                const request = store.get(id);

                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => {
                    console.error('Error getting song:', event.target.error);
                    reject(event.target.error);
                };
            });
        };
        
        const updateSong = (songData) => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([SONG_STORE], 'readwrite');
                const store = transaction.objectStore(SONG_STORE);
                const request = store.put(songData); 

                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error('Error updating song:', event.target.error);
                    reject(event.target.error);
                };
            });
        };

        // --- Artist Functions (NEW) ---
        const saveArtistImage = (artistName, imageBlob) => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ARTIST_STORE], 'readwrite');
                const store = transaction.objectStore(ARTIST_STORE);
                const request = store.put({ artistName: artistName, imageBlob: imageBlob }); 
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        };

        const getArtistImage = (artistName) => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ARTIST_STORE], 'readonly');
                const store = transaction.objectStore(ARTIST_STORE);
                const request = store.get(artistName);
                request.onsuccess = (e) => resolve(e.target.result); 
                request.onerror = (e) => reject(e.target.error);
            });
        };
        
        const getAllArtistImages = () => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ARTIST_STORE], 'readonly');
                const store = transaction.objectStore(ARTIST_STORE);
                const request = store.getAll();
                request.onsuccess = (e) => resolve(e.target.result); 
                request.onerror = (e) => reject(e.target.error);
            });
        };

        // --- Playlist Functions ---
        const createPlaylist = async () => {
            showAlert('Playlist creation needs a name. (Simulating "My Playlist")');
            console.warn("Prompt() is not allowed. Defaulting playlist name.");
            const name = 'My Playlist';
            
            // NEW: Playlist object now includes optional imageBlob
            const newPlaylist = { name, songIds: [], imageBlob: null };
            
            const transaction = db.transaction([PLAYLIST_STORE], 'readwrite');
            const store = transaction.objectStore(PLAYLIST_STORE);
            store.add(newPlaylist);

            await new Promise((resolve) => { transaction.oncomplete = resolve; });
            
            showAlert(`Playlist "${name}" created!`);
            refreshPlaylists(); 
            await refreshAllData(); 
        };
        
        const getAllPlaylists = () => {
             return new Promise((resolve, reject) => {
                const transaction = db.transaction([PLAYLIST_STORE], 'readonly');
                const store = transaction.objectStore(PLAYLIST_STORE);
                const request = store.getAll();

                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => {
                    console.error('Error getting playlists:', event.target.error);
                    reject(event.target.error);
                };
            });
        };

        // NEW: Get a single playlist by ID
        const getPlaylistById = (id) => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([PLAYLIST_STORE], 'readonly');
                const store = transaction.objectStore(PLAYLIST_STORE);
                const request = store.get(id);

                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => {
                    console.error('Error getting playlist:', event.target.error);
                    reject(event.target.error);
                };
            });
        };
        
        // NEW: Update an entire playlist object
        const updatePlaylistDB = (playlistData) => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([PLAYLIST_STORE], 'readwrite');
                const store = transaction.objectStore(PLAYLIST_STORE);
                const request = store.put(playlistData); 

                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error('Error updating playlist:', event.target.error);
                    reject(event.target.error);
                };
            });
        };

        // NEW: Delete a playlist by ID
        const deletePlaylistDB = (id) => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([PLAYLIST_STORE], 'readwrite');
                const store = transaction.objectStore(PLAYLIST_STORE);
                const request = store.delete(id); 

                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error('Error deleting playlist:', event.target.error);
                    reject(event.target.error);
                };
            });
        };

        const addSongToPlaylist = async (playlistId, songId) => {
            const tx = db.transaction([PLAYLIST_STORE], 'readwrite');
            const store = tx.objectStore(PLAYLIST_STORE);
            const req = store.get(playlistId);
            
            req.onsuccess = async (event) => {
                const playlist = event.target.result;
                if (playlist && !playlist.songIds.includes(songId)) {
                    playlist.songIds.push(songId);
                    store.put(playlist);
                    showAlert('Song added to playlist!');
                    
                    await new Promise(resolve => tx.oncomplete = resolve);
                    await refreshPlaylists(); 
                    
                    if (currentViewedPlaylistId === playlistId) {
                        renderPlaylistDetailView(playlistId); 
                    }
                    await renderHome(); 
                    
                } else if (playlist.songIds.includes(songId)) {
                    showAlert('Song is already in this playlist.');
                }
                closeAddToPlaylistModal();
            };
            req.onerror = (event) => {
                 console.error('Error adding to playlist:', event.target.error);
                 closeAddToPlaylistModal();
            };
        };
        
        const removeSongFromPlaylist = async (playlistId, songId) => {
            const tx = db.transaction([PLAYLIST_STORE], 'readwrite');
            const store = tx.objectStore(PLAYLIST_STORE);
            const req = store.get(playlistId);

            req.onsuccess = async (event) => {
                const playlist = event.target.result;
                if (playlist) {
                    const songIndex = playlist.songIds.indexOf(songId);
                    if (songIndex > -1) {
                        playlist.songIds.splice(songIndex, 1);
                        store.put(playlist);
                        
                        await new Promise(resolve => tx.oncomplete = resolve);
                        await refreshPlaylists(); 
                        
                        showAlert('Song removed from playlist.');
                        
                        renderPlaylistDetailView(playlistId);
                        await renderHome(); 
                    }
                }
            };
            req.onerror = (event) => {
                 console.error('Error removing from playlist:', event.target.error);
            };
        };


        // --- Player Functions ---
        const playSong = async (songId) => {
            try {
                const song = await getSongById(songId);
                if (!song) {
                    console.error("Song not found:", songId);
                    showAlert("Error: Song data could not be loaded.");
                    return;
                }

                currentlyPlaying = song;

                const audioURL = URL.createObjectURL(song.audioBlob);
                const imageURL = URL.createObjectURL(song.imageBlob);

                audioPlayer.src = audioURL;
                audioPlayer.play().catch(e => {
                    console.error("Audio play failed:", e);
                    showAlert("Playback failed. Please try again.");
                });

                playerThumbnail.src = imageURL;
                playerTitle.textContent = song.title;
                playerArtist.textContent = song.artist;

                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            } catch (error) {
                console.error("Error in playSong:", error);
                showAlert("An error occurred while trying to play the song.");
            }
        };

        // NEW: Play first song in a playlist
        const playPlaylist = async (playlistId) => {
            const playlist = await getPlaylistById(playlistId);
            if (playlist && playlist.songIds.length > 0) {
                playSong(playlist.songIds[0]);
            } else {
                showAlert("This playlist is empty.");
            }
        };

        const togglePlayPause = () => {
            if (!currentlyPlaying) {
                if (currentSongs.length > 0) {
                    playSong(currentSongs[0].id);
                } else {
                    showAlert('No songs in your library to play.');
                }
                return;
            }
            if (audioPlayer.paused) {
                audioPlayer.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            } else {
                audioPlayer.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            }
        };

        const playNextSong = () => {
            if (!currentSongs || currentSongs.length === 0) return;
            let currentIndex = -1;
            if (currentlyPlaying) {
                currentIndex = currentSongs.findIndex(song => song.id === currentlyPlaying.id);
            }
            let nextIndex = currentIndex + 1;
            if (nextIndex >= currentSongs.length) {
                nextIndex = 0; 
            }
            playSong(currentSongs[nextIndex].id);
        };

        const playPreviousSong = () => {
            if (!currentSongs || currentSongs.length === 0) return;
            let currentIndex = 0; 
            if (currentlyPlaying) {
                currentIndex = currentSongs.findIndex(song => song.id === currentlyPlaying.id);
            }
            let prevIndex = currentIndex - 1;
            if (prevIndex < 0) {
                prevIndex = currentSongs.length - 1; 
            }
            playSong(currentSongs[prevIndex].id);
        };

        // --- Rendering Functions ---
        const renderLibrary = (songsToRender = null) => {
            const songListContainer = document.getElementById('library-song-list');
            const songs = songsToRender || currentSongs;
            songListContainer.innerHTML = ''; 

            if (songs.length === 0) {
                songListContainer.innerHTML = `<p class="text-gray-400 p-4">Your library is empty.</p>`;
                return;
            }
            
            songs.forEach((song, index) => {
                const songElement = document.createElement('div');
                songElement.className = 'grid grid-cols-12 gap-4 items-center p-2 rounded-lg hover:bg-white/10 group';
                songElement.innerHTML = `
                    <div class="col-span-1 text-gray-400 group-hover:text-white">${index + 1}</div>
                    <div class="col-span-5 flex items-center space-x-3">
                        <img src="${URL.createObjectURL(song.imageBlob)}" class="w-10 h-10 rounded" onerror="this.src='https://placehold.co/40x40/191414/1DB954?text=G'">
                        <div>
                            <div class="text-white font-semibold">${song.title}</div>
                            <div class="text-gray-400 text-sm">${song.artist}</div>
                        </div>
                    </div>
                    <div class="col-span-4 text-gray-400">${song.artist}</div>
                    <div class="col-span-2 flex space-x-2">
                        <button title="Play" class="text-gray-400 hover:text-white" onclick="playSong(${song.id})">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11v11.78a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                        </button>
                        <button title="Add to Playlist" class="text-gray-400 hover:text-white" onclick="openAddToPlaylistModal(${song.id})">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                        </button>
                        <button title="Edit Song" class="text-gray-400 hover:text-white" onclick="openEditSongModal(${song.id})">
                             <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 13H3V6a1 1 0 011-1h9l-2 2H5v7z"></path></svg>
                        </button>
                        <button title="Delete Song" class="text-gray-400 hover:text-red-500" onclick="deleteSong(${song.id})">
                             <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011 1v6a1 1 0 11-2 0V9a1 1 0 011-1zm5 0a1 1 0 011 1v6a1 1 0 11-2 0V9a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                `;
                songListContainer.appendChild(songElement);
            });
        };
        
        const renderHome = async () => { 
            // === 1. Recently Added ===
            const recentContainer = document.getElementById('home-recent-container'); 
            recentContainer.innerHTML = '';
            
            const recentSongs = [...currentSongs].reverse().slice(0, 100); 
            
            if (recentSongs.length === 0) {
                 recentContainer.innerHTML = `<p class="text-gray-400">No songs added yet.</p>`; 
            } else {
                recentSongs.forEach(song => {
                    const card = document.createElement('div');
                    card.className = 'bg-white/10 p-4 rounded-lg shadow-lg hover:bg-white/20 transition-all cursor-pointer group w-48 flex-shrink-0'; 
                    card.onclick = () => playSong(song.id);
                    card.innerHTML = `
                        <div class="relative mb-4">
                            <img src="${URL.createObjectURL(song.imageBlob)}" class="w-full h-auto rounded-md aspect-square object-cover" onerror="this.src='https://placehold.co/160x160/191414/1DB954?text=GOLIFY'">
                            <button class="absolute bottom-2 right-2 w-12 h-12 bg-[#1DB954] rounded-full flex items-center justify-center text-black opacity-0 group-hover:opacity-100 transform translate-y-2 group-hover:translate-y-0 transition-all shadow-lg">
                                <svg class="w-6 h-6 ml-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11v11.78a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                            </button>
                        </div>
                        <h4 class="font-bold text-white truncate">${song.title}</h4>
                        <p class="text-sm text-gray-400 truncate">${song.artist}</p>
                    `;
                    recentContainer.appendChild(card); 
                });
            }

            // === 2. Your Playlists ===
            const playlistsContainer = document.getElementById('home-playlists-container');
            playlistsContainer.innerHTML = ''; 
            
            if (currentPlaylists.length === 0) {
                playlistsContainer.innerHTML = `<p class="text-gray-400">No playlists created yet.</p>`;
            } else {
                for (const playlist of currentPlaylists) {
                    let imgUrl = 'https://placehold.co/160x160/191414/1DB954?text=GOLIFY';
                    
                    // NEW: Check for custom playlist image
                    if (playlist.imageBlob) {
                        imgUrl = URL.createObjectURL(playlist.imageBlob);
                    } else if (playlist.songIds.length > 0) {
                        try {
                            const firstSong = await getSongById(playlist.songIds[0]);
                            if (firstSong && firstSong.imageBlob) {
                                imgUrl = URL.createObjectURL(firstSong.imageBlob);
                            }
                        } catch (e) { console.error("Could not load playlist song for image", e); }
                    }

                    const card = document.createElement('div');
                    card.className = 'bg-white/10 p-4 rounded-lg shadow-lg hover:bg-white/20 transition-all cursor-pointer group w-48 flex-shrink-0';
                    card.onclick = () => renderPlaylistDetailView(playlist.id);
                    card.innerHTML = `
                        <div class="relative mb-4">
                            <img src="${imgUrl}" class="w-full h-auto rounded-md aspect-square object-cover" onerror="this.src='https://placehold.co/160x160/191414/1DB954?text=GOLIFY'">
                        </div>
                        <h4 class="font-bold text-white truncate">${playlist.name}</h4>
                        <p class="text-sm text-gray-400 truncate">${playlist.songIds.length} ${playlist.songIds.length === 1 ? 'song' : 'songs'}</p>
                    `;
                    playlistsContainer.appendChild(card);
                }
            }

            // === 3. Your Artists ===
            const artistsContainer = document.getElementById('home-artists-container');
            artistsContainer.innerHTML = ''; 

            const artistMap = new Map();
            currentSongs.forEach(song => {
                const artistName = song.artist || 'Unknown Artist';
                let artistData = artistMap.get(artistName);
                if (!artistData) {
                    let img = currentArtistImages.get(artistName); 
                    if (!img && song.imageBlob) {
                        img = URL.createObjectURL(song.imageBlob);
                    } else if (!img) {
                        img = 'https://placehold.co/160x160/191414/1DB954?text=ARTIST';
                    }
                    
                    artistData = {
                        name: artistName,
                        songCount: 0,
                        imageUrl: currentArtistImages.get(artistName) || img 
                    };
                    artistMap.set(artistName, artistData);
                }
                artistData.songCount++;
            });

            const artists = Array.from(artistMap.values());
            artists.sort((a, b) => a.name.localeCompare(b.name));

            if (artists.length === 0) {
                artistsContainer.innerHTML = `<p class="text-gray-400">No artists found in your library.</p>`;
            } else {
                artists.forEach(artist => {
                    const card = document.createElement('div');
                    card.className = 'bg-white/10 p-4 rounded-lg shadow-lg hover:bg-white/20 transition-all cursor-pointer group w-48 flex-shrink-0 flex flex-col items-center';
                    const safeArtistName = artist.name.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    card.onclick = () => renderArtistDetailView(safeArtistName);
                    card.innerHTML = `
                        <div class="relative mb-4 w-full">
                            <img src="${artist.imageUrl}" class="w-full h-auto rounded-full aspect-square object-cover" onerror="this.src='https://placehold.co/160x160/191414/1DB954?text=ARTIST'">
                        </div>
                        <h4 class="font-bold text-white truncate">${artist.name}</h4>
                        <p class="text-sm text-gray-400">${artist.songCount} ${artist.songCount === 1 ? 'song' : 'songs'}</p>
                    `;
                    artistsContainer.appendChild(card);
                });
            }
        };

        const renderArtistsView = () => {
            const grid = document.getElementById('artist-grid');
            grid.innerHTML = '';
            
            const artistMap = new Map();
            currentSongs.forEach(song => {
                const artistName = song.artist || 'Unknown Artist';
                if (!artistMap.has(artistName)) {
                    artistMap.set(artistName, {
                        name: artistName,
                        songs: [],
                        imageUrl: URL.createObjectURL(song.imageBlob) 
                    });
                }
                artistMap.get(artistName).songs.push(song);
            });

            const artists = Array.from(artistMap.values());
            
            if (artists.length === 0) {
                grid.innerHTML = `<p class="text-gray-400 col-span-full">No artists found. Add songs to your library.</p>`;
                return;
            }
            
            artists.sort((a, b) => a.name.localeCompare(b.name)); 
            
            artists.forEach(artist => {
                const customImgUrl = currentArtistImages.get(artist.name);
                const finalImgUrl = customImgUrl || artist.imageUrl; 

                const card = document.createElement('div');
                card.className = 'bg-white/10 p-4 rounded-lg shadow-lg hover:bg-white/20 transition-all cursor-pointer group flex flex-col items-center';
                const safeArtistName = artist.name.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                card.onclick = () => renderArtistDetailView(safeArtistName);
                card.innerHTML = `
                    <div class="relative mb-4 w-full">
                        <img src="${finalImgUrl}" class="w-full h-auto rounded-full aspect-square object-cover" onerror="this.src='https://placehold.co/160x160/191414/1DB954?text=ARTIST'">
                    </div>
                    <h4 class="font-bold text-white truncate">${artist.name}</h4>
                    <p class="text-sm text-gray-400">${artist.songs.length} ${artist.songs.length === 1 ? 'song' : 'songs'}</p>
                `;
                grid.appendChild(card);
            });
        };

        const renderArtistDetailView = async (artistName) => {
            const songs = currentSongs.filter(song => (song.artist || 'Unknown Artist') === artistName);
            
            if (songs.length === 0) {
                showAlert('Artist not found or has no songs.');
                return;
            }

            const customArtist = await getArtistImage(artistName);
            const imgUrl = customArtist
                ? URL.createObjectURL(customArtist.imageBlob)
                : (songs[0].imageBlob ? URL.createObjectURL(songs[0].imageBlob) : 'https://placehold.co/160x160/191414/1DB954?text=ARTIST'); 
            
            document.getElementById('artist-detail-img').src = imgUrl;
            document.getElementById('artist-detail-name').textContent = artistName;
            document.getElementById('artist-detail-desc').textContent = `${songs.length} ${songs.length === 1 ? 'song' : 'songs'}`;
            
            const changeBtn = document.getElementById('change-artist-img-btn');
            const safeArtistName = artistName.replace(/'/g, "\\'").replace(/"/g, "&quot;");
            changeBtn.setAttribute('onclick', `triggerArtistImageUpload('${safeArtistName}')`);
            
            const songListContainer = document.getElementById('artist-song-list');
            songListContainer.innerHTML = '';
            
            songs.forEach((song, index) => {
                const songElement = document.createElement('div');
                songElement.className = 'grid grid-cols-12 gap-4 items-center p-2 rounded-lg hover:bg-white/10 group';
                songElement.innerHTML = `
                    <div class="col-span-1 text-gray-400 group-hover:text-white">${index + 1}</div>
                    <div class="col-span-5 flex items-center space-x-3">
                        <img src="${URL.createObjectURL(song.imageBlob)}" class="w-10 h-10 rounded" onerror="this.src='https://placehold.co/40x40/191414/1DB954?text=G'">
                        <div>
                            <div class="text-white font-semibold">${song.title}</div>
                            <div class="text-gray-400 text-sm">${song.artist}</div>
                        </div>
                    </div>
                    <div class="col-span-4 text-gray-400">${song.artist}</div>
                    <div class="col-span-2 flex space-x-2">
                        <button title="Play" class="text-gray-400 hover:text-white" onclick="playSong(${song.id})">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11v11.78a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                        </button>
                        <button title="Add to Playlist" class="text-gray-400 hover:text-white" onclick="openAddToPlaylistModal(${song.id})">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                        </button>
                        <button title="Edit Song" class="text-gray-400 hover:text-white" onclick="openEditSongModal(${song.id})">
                             <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 13H3V6a1 1 0 011-1h9l-2 2H5v7z"></path></svg>
                        </button>
                    </div>
                `;
                songListContainer.appendChild(songElement);
            });

            showView('artistDetail');
        };

        const renderPlaylists = () => {
            const playlistListContainer = document.getElementById('playlist-list');
            playlistListContainer.innerHTML = ''; 

            if (currentPlaylists.length === 0) {
                playlistListContainer.innerHTML = `<li class="text-sm text-gray-500 px-1">No playlists yet.</li>`;
                return;
            }

            currentPlaylists.forEach(playlist => {
                const playlistElement = document.createElement('li');
                playlistElement.innerHTML = `
                    <a href="#" class="block text-gray-400 hover:text-white truncate" onclick="event.preventDefault(); renderPlaylistDetailView(${playlist.id})">
                        ${playlist.name}
                    </a>
                `;
                playlistListContainer.appendChild(playlistElement);
            });
        };
        
        const renderPlaylistDetailView = async (playlistId) => {
            currentViewedPlaylistId = playlistId;
            
            // const playlist = currentPlaylists.find(p => p.id === playlistId); // Use DB instead
            const playlist = await getPlaylistById(playlistId);
            if (!playlist) {
                showAlert('Playlist not found.');
                showView('library'); 
                return;
            }

            document.getElementById('playlist-view-name').textContent = playlist.name;

            // Set up control buttons
            document.getElementById('playlist-play-btn').onclick = () => playPlaylist(playlist.id);
            document.getElementById('playlist-edit-btn').onclick = () => openEditPlaylistModal(playlist.id);

            const songPromises = playlist.songIds.map(id => getSongById(id));
            const songs = (await Promise.all(songPromises)).filter(Boolean); 
            
            const songListContainer = document.getElementById('playlist-song-list');
            songListContainer.innerHTML = '';

            // NEW: Set playlist image (custom, first song, or placeholder)
            let imgUrl = 'https://placehold.co/160x160/191414/1DB954?text=GOLIFY';
            if (playlist.imageBlob) {
                imgUrl = URL.createObjectURL(playlist.imageBlob);
            } else if (songs.length > 0) {
                imgUrl = URL.createObjectURL(songs[0].imageBlob);
            }
            document.getElementById('playlist-view-img').src = imgUrl;


            if (songs.length === 0) {
                document.getElementById('playlist-view-desc').textContent = 'This playlist is empty.';
                songListContainer.innerHTML = `<p class="text-gray-400 p-4">Add some songs to this playlist!</p>`;
            } else {
                document.getElementById('playlist-view-desc').textContent = `${songs.length} ${songs.length === 1 ? 'song' : 'songs'}`;

                songs.forEach((song, index) => {
                    const songElement = document.createElement('div');
                    songElement.className = 'grid grid-cols-12 gap-4 items-center p-2 rounded-lg hover:bg-white/10 group';
                    songElement.innerHTML = `
                        <div class="col-span-1 text-gray-400 group-hover:text-white">${index + 1}</div>
                        <div class="col-span-5 flex items-center space-x-3">
                            <img src="${URL.createObjectURL(song.imageBlob)}" class="w-10 h-10 rounded" onerror="this.src='https://placehold.co/40x40/191414/1DB954?text=G'">
                            <div>
                                <div class="text-white font-semibold">${song.title}</div>
                                <div class="text-gray-400 text-sm">${song.artist}</div>
                            </div>
                        </div>
                        <div class="col-span-4 text-gray-400">${song.artist}</div>
                        <div class="col-span-2 flex space-x-2">
                            <button title="Play" class="text-gray-400 hover:text-white" onclick="playSong(${song.id})">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11v11.78a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                        </button>
                        <button title="Edit Song" class="text-gray-400 hover:text-white" onclick="openEditSongModal(${song.id})">
                             <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 13H3V6a1 1 0 011-1h9l-2 2H5v7z"></path></svg>
                        </button>
                        <button title="Remove from Playlist" class="text-gray-400 hover:text-red-500" onclick="removeSongFromPlaylist(${playlist.id}, ${song.id})">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>
                        </button>
                        </div>
                    `;
                    songListContainer.appendChild(songElement);
                });
            }

            showView('playlist');
        };

        // --- Data Refresh ---
        const refreshAllData = async () => {
            await Promise.all([refreshSongs(), refreshPlaylists(), refreshArtistImages()]);
            renderLibrary();
            await renderHome(); 
            renderArtistsView(); 
        };
 
        const refreshSongs = async () => {
            currentSongs = await getAllSongs();
            currentSongs.forEach(song => {
                if (song.audioBlobUrl) URL.revokeObjectURL(song.audioBlobUrl);
                if (song.imageBlobUrl) URL.revokeObjectURL(song.imageBlobUrl);
            });
        };
        
        const refreshPlaylists = async () => {
            currentPlaylists = await getAllPlaylists();
            renderPlaylists();
        };

        const refreshArtistImages = async () => {
            const images = await getAllArtistImages();
            currentArtistImages.forEach(url => URL.revokeObjectURL(url));
            currentArtistImages.clear();
            images.forEach(artist => {
                currentArtistImages.set(artist.artistName, URL.createObjectURL(artist.imageBlob));
            });
        };

        // --- Modal Handlers ---
        const openAddSongModal = () => addSongModal.classList.remove('hidden');
        const closeAddSongModal = () => {
            document.getElementById('add-song-form').reset();
            addSongModal.classList.add('hidden');
        };

        const openEditSongModal = async (songId) => {
            try {
                const song = await getSongById(songId);
                if (!song) {
                    showAlert('Error: Song not found.');
                    return;
                }
                document.getElementById('edit-song-id').value = song.id;
                document.getElementById('edit-song-title').value = song.title;
                document.getElementById('edit-song-artist').value = song.artist;
                document.getElementById('edit-song-file').value = null;
                document.getElementById('edit-thumbnail-file').value = null;
                editSongModal.classList.remove('hidden');
            } catch (error) {
                showAlert('Error loading song data for editing.');
            }
        };

        const closeEditSongModal = () => {
            document.getElementById('edit-song-form').reset();
            editSongModal.classList.add('hidden');
        };

        const openAddToPlaylistModal = (songId) => {
            songToAddToPlaylist = songId;
            const modalList = document.getElementById('modal-playlist-list');
            modalList.innerHTML = '';
            
            if (currentPlaylists.length === 0) {
                modalList.innerHTML = `<p class="text-gray-400">No playlists found. Create one first!</p>`;
            }
            
            currentPlaylists.forEach(playlist => {
                const item = document.createElement('button');
                item.className = 'block w-full text-left p-2 rounded hover:bg-white/10';
                item.textContent = playlist.name;
                item.onclick = () => addSongToPlaylist(playlist.id, songToAddToPlaylist);
                modalList.appendChild(item);
            });
            
            addToPlaylistModal.classList.remove('hidden');
        };
        
        const closeAddToPlaylistModal = () => {
            songToAddToPlaylist = null;
            addToPlaylistModal.classList.add('hidden');
        };
        
        // --- NEW: Edit Playlist Modal Functions ---
        const openEditPlaylistModal = async (playlistId) => {
            const playlist = await getPlaylistById(playlistId);
            if (!playlist) {
                showAlert('Error: Playlist not found.');
                return;
            }
            
            // Reset modal state
            cancelDeleteConfirmation();
            
            document.getElementById('edit-playlist-id').value = playlist.id;
            document.getElementById('edit-playlist-name').value = playlist.name;
            document.getElementById('edit-playlist-image').value = null;
            
            // Set delete button's final action
            document.getElementById('confirm-delete-playlist-btn').onclick = () => deletePlaylist(playlist.id);
            
            editPlaylistModal.classList.remove('hidden');
        };

        const closeEditPlaylistModal = () => {
            document.getElementById('edit-playlist-form').reset();
            editPlaylistModal.classList.add('hidden');
        };

        const showDeleteConfirmation = () => {
            editPlaylistFormView.classList.add('hidden');
            deletePlaylistConfirmView.classList.remove('hidden');
        };

        const cancelDeleteConfirmation = () => {
            editPlaylistFormView.classList.remove('hidden');
            deletePlaylistConfirmView.classList.add('hidden');
        };

        const deletePlaylist = async (playlistId) => {
            try {
                await deletePlaylistDB(playlistId);
                showAlert('Playlist deleted.');
                closeEditPlaylistModal();
                await refreshAllData();
                showView('home'); // Go to home screen
            } catch (error) {
                showAlert('Error deleting playlist.');
            }
        };
        // --- End of Edit Playlist Modal Functions ---

        const showShareModal = (type) => {
            const message = type === 'app'
                ? "This is a local prototype. To share, you'd need a full backend!"
                : "Song sharing requires a server to host the file. This is a local-only app.";
            showAlert(message);
        };

        let currentArtistToUpdate = null; 
        const triggerArtistImageUpload = (artistName) => {
            currentArtistToUpdate = artistName;
            document.getElementById('artist-image-upload').click();
        };

        // --- Event Listeners ---

        document.getElementById('add-song-form').onsubmit = async (e) => {
            e.preventDefault();
            const title = document.getElementById('song-title').value;
            const artist = document.getElementById('song-artist').value;
            const audioFile = document.getElementById('song-file').files[0];
            const imageFile = document.getElementById('thumbnail-file').files[0];

            if (!title || !artist || !audioFile || !imageFile) {
                showAlert('Please fill out all fields.');
                return;
            }
            const songData = { title, artist, audioBlob: audioFile, imageBlob: imageFile };

            try {
                await addSong(songData);
                showAlert('Song added to your library!');
                closeAddSongModal();
                await refreshAllData(); 
            } catch (error) {
                showAlert('Failed to add song. Storage may be full.');
            }
        };

        document.getElementById('edit-song-form').onsubmit = async (e) => {
            e.preventDefault();
            const songId = parseInt(document.getElementById('edit-song-id').value, 10);
            const title = document.getElementById('edit-song-title').value;
            const artist = document.getElementById('edit-song-artist').value;
            const audioFile = document.getElementById('edit-song-file').files[0];
            const imageFile = document.getElementById('edit-thumbnail-file').files[0];

            if (!songId || !title || !artist) {
                showAlert('Please fill out title and artist.');
                return;
            }

            try {
                const originalSong = await getSongById(songId);
                if (!originalSong) {
                    showAlert('Error: Could not find original song to update.');
                    return;
                }
                const updatedSongData = {
                    id: songId,
                    title: title,
                    artist: artist,
                    audioBlob: audioFile || originalSong.audioBlob,
                    imageBlob: imageFile || originalSong.imageBlob
                };
                await updateSong(updatedSongData);
                showAlert('Song updated successfully!');
                closeEditSongModal();
                await refreshAllData(); 

                if (currentViewedPlaylistId) {
                    const playlist = await getPlaylistById(currentViewedPlaylistId); // Re-fetch
                    if (playlist && playlist.songIds.includes(songId)) {
                        renderPlaylistDetailView(currentViewedPlaylistId);
                    }
                }
                
                if (views.artistDetail.classList.contains('hidden') === false) {
                    const artistName = document.getElementById('artist-detail-name').textContent;
                    if (artistName === originalSong.artist || artistName === updatedSongData.artist) {
                        renderArtistDetailView(updatedSongData.artist);
                    }
                }
            } catch (error) {
                console.error("Error updating song:", error);
                showAlert('Failed to update song.');
            }
        };

        // NEW: Edit Playlist Form
        document.getElementById('edit-playlist-form').onsubmit = async (e) => {
            e.preventDefault();

            const playlistId = parseInt(document.getElementById('edit-playlist-id').value, 10);
            const name = document.getElementById('edit-playlist-name').value;
            const imageFile = document.getElementById('edit-playlist-image').files[0];

            if (!playlistId || !name) {
                showAlert('Playlist name is required.');
                return;
            }

            try {
                const originalPlaylist = await getPlaylistById(playlistId);
                if (!originalPlaylist) {
                    showAlert('Error: Could not find original playlist.');
                    return;
                }

                const updatedPlaylist = {
                    id: playlistId,
                    name: name,
                    songIds: originalPlaylist.songIds,
                    // Use new file if provided, otherwise keep old one
                    imageBlob: imageFile || originalPlaylist.imageBlob 
                };

                await updatePlaylistDB(updatedPlaylist);
                showAlert('Playlist updated!');
                closeEditPlaylistModal();
                
                // Refresh data and current view
                await refreshAllData(); 
                if (currentViewedPlaylistId === playlistId) {
                    await renderPlaylistDetailView(playlistId);
                }

            } catch (error) {
                console.error('Error updating playlist:', error);
                showAlert('Failed to update playlist.');
            }
        };


        // Player Controls
        playPauseBtn.onclick = togglePlayPause;

        audioPlayer.onloadedmetadata = () => {
            durationEl.textContent = formatTime(audioPlayer.duration);
            seekBar.max = audioPlayer.duration;
        };

        audioPlayer.ontimeupdate = () => {
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
            seekBar.value = audioPlayer.currentTime;
        };
        
        audioPlayer.onended = () => {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            playNextSong();
        };

        seekBar.oninput = () => {
            audioPlayer.currentTime = seekBar.value;
        };

        volumeBar.oninput = () => {
            audioPlayer.volume = volumeBar.svalue;
        };
        
        document.getElementById('search-bar').onkeyup = (e) => {
            const query = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('search-results');
            
            if (!query) {
                resultsContainer.innerHTML = '';
                return;
            }
            
            const results = currentSongs.filter(song => 
                song.title.toLowerCase().includes(query) || 
                song.artist.toLowerCase().includes(query)
            );
            
            resultsContainer.innerHTML = '';
            if (results.length === 0) {
                resultsContainer.innerHTML = `<p class="text-gray-400">No results found.</p>`;
                return;
            }
            
            results.forEach(song => {
                const songElement = document.createElement('div');
                songElement.className = 'flex items-center space-x-4 p-2 rounded-lg hover:bg-white/10 group';
                songElement.innerHTML = `
                    <img src="${URL.createObjectURL(song.imageBlob)}" class="w-12 h-12 rounded" onerror="this.src='https://placehold.co/48x48/191414/1DB954?text=G'">
                    <div>
                        <div class="text-white font-semibold">${song.title}</div>
                        <div class="text-gray-400 text-sm">${song.artist}</div>
                    </div>
                    <button title="Play" class="ml-auto text-gray-400 hover:text-white" onclick="playSong(${song.id})">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11v11.78a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                    </button>
                `;
                resultsContainer.appendChild(songElement);
            });
        };

        document.getElementById('artist-image-upload').onchange = async (e) => {
            const file = e.target.files[0];
            const artistName = currentArtistToUpdate;
            
            if (!file || !artistName) {
                return;
            }

            try {
                await saveArtistImage(artistName, file);
                showAlert('Artist image updated!');
                
                await refreshArtistImages();
                
                renderArtistDetailView(artistName); 
                renderArtistsView();
                await renderHome();

            } catch (error) {
                console.error('Error saving artist image:', error);
                showAlert('Failed to save image.');
            }
            
            e.target.value = null; 
            currentArtistToUpdate = null;
        };

        // --- App Initialization ---
        window.onload = async () => {
            try {
                await openDB();
                await refreshAllData();
                showAlert('GOLIFY loaded successfully!');
            } catch (error) {
                showAlert('Error loading database. App may not function correctly.');
                console.error(error);
            }
        };

    </script>
</body>
</html>